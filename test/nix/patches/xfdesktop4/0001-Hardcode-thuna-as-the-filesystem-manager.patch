From 4bb084b4c8f08c3e947e7f19c7bee8d996016725 Mon Sep 17 00:00:00 2001
From: Wei Zhang <ruoyuan.zw@antgroup.com>
Date: Wed, 24 Sep 2025 15:06:29 +0800
Subject: [PATCH] Hardcode thuna as the filesystem manager

Signed-off-by: Wei Zhang <ruoyuan.zw@antgroup.com>
---
 src/xfdesktop-file-utils.c | 53 ++++++++++++++++++++++++++++----------
 1 file changed, 39 insertions(+), 14 deletions(-)

diff --git a/src/xfdesktop-file-utils.c b/src/xfdesktop-file-utils.c
index 1ae49a4..a6952de 100644
--- a/src/xfdesktop-file-utils.c
+++ b/src/xfdesktop-file-utils.c
@@ -44,6 +44,7 @@
 #include <gio/gio.h>
 #include <gio/gunixinputstream.h>
 #include <gio/gunixmounts.h>
+#include <gio/gdesktopappinfo.h>
 
 #include <glib.h>
 #include <gtk/gtk.h>
@@ -1593,23 +1594,47 @@ xfdesktop_file_utils_execute(GFile *working_directory,
         g_free(working_dir);
         g_free(display_name);
     } else {
-        gchar *filename = g_file_get_uri(file);
-        gchar *name = g_filename_display_basename(filename);
-        gchar *primary = g_markup_printf_escaped(_("Failed to run \"%s\""), name);
+        GFileInfo *info = g_file_query_info(file,
+                            G_FILE_ATTRIBUTE_STANDARD_TYPE "," G_FILE_ATTRIBUTE_STANDARD_CONTENT_TYPE,
+                            G_FILE_QUERY_INFO_NONE,
+                            NULL, NULL);
+        gchar *uri = g_file_get_uri(file);
+        gboolean launched = FALSE;
+        GError *error = NULL;
+        if (info && xfdesktop_file_utils_is_desktop_file(info)) {
+            // .desktop file: launch with exo-open
+            gchar *argv[] = { "exo-open", g_file_get_path(file), NULL };
+            launched = g_spawn_async(NULL, argv, NULL, G_SPAWN_SEARCH_PATH, NULL, NULL, NULL, &error);
+        } else if (info && g_file_info_get_file_type(info) == G_FILE_TYPE_DIRECTORY) {
+            // Directory: open in Thunar
+            gchar *argv[] = { "thunar", uri, NULL };
+            launched = g_spawn_async(NULL, argv, NULL, G_SPAWN_SEARCH_PATH, NULL, NULL, NULL, &error);
+        } else {
+            // Regular file: open with default application
+            gchar *argv[] = { "exo-open", uri, NULL };
+            launched = g_spawn_async(NULL, argv, NULL, G_SPAWN_SEARCH_PATH, NULL, NULL, NULL, &error);
+        }
 
-        xfce_message_dialog(parent,
-                            _("Launch Error"), "dialog-error",
-                            primary,
-                            _("This feature requires a file manager service to "
-                              "be present (such as the one supplied by Thunar)."),
-                            XFCE_BUTTON_TYPE_MIXED, "window-close", _("_Close"), GTK_RESPONSE_ACCEPT,
-                            NULL);
+        if (!launched) {
+            gchar *name = g_filename_display_basename(uri);
+            gchar *primary = g_markup_printf_escaped(_("Failed to run \"%s\""), name);
 
-        g_free(primary);
-        g_free(name);
-        g_free(filename);
+            xfce_message_dialog(parent,
+                    _("Launch Error"), "dialog-error",
+                    primary,
+                    error ? error->message : _("Failed to launch file"),
+                    XFCE_BUTTON_TYPE_MIXED, "window-close", _("_Close"), GTK_RESPONSE_ACCEPT,
+                    NULL);
+            g_free(primary);
+            g_free(name);
+            if (error)
+            g_error_free(error);
+            success = FALSE;
+        }
 
-        success = FALSE;
+        g_free(uri);
+        if (info)
+            g_object_unref(info);
     }
 
     return success;
-- 
2.43.0

